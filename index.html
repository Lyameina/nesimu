<!DOCTYPE HTML SYSTEM>
<html>
<head>
	<link rel="stylesheet" type="text/css" href="css/index.css">
	<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/2.1.0/jquery.min.js"></script>
	<meta http-equiv="content-type" content="text/html; charset=utf-8" >
	<meta name="description" 
		content="Bienvenue sur ma page de présentation. Je suis Maylanie Mesnier, étudiante à Polytech Sophia Antipolis en Ingénieurie Informatique. "/>
	<title >Maylanie Mesnier</title>
	
</head>
<body>
<object type="image/svg+xml" data="img/svg/nesimu.svg" >
  <param name="src" value="img/svg/nesimu.svg" >
  <img src="facto.png" alt="svg image of facto.svg" />
</object>
<div id="nes">
<div id="emulator"></div>
</div>

  <script>
    var hasGP = false;
    var repGP;
    var input = {
        left: false,
        right: false,
        up: false,
        down: false,
        a:false,
        b:false,
        start:false
    };
 
    function canGame() {
        return "getGamepads" in navigator;
    }
 /*
    function reportOnGamepad() {
        var gp = navigator.getGamepads()[0];
        var html = "";
            html += "id: "+gp.id+"<br/>";
 
        for(var i=0;i<gp.buttons.length;i++) {
            html+= "Button "+(i+1)+": ";
            if(gp.buttons[i].pressed) html+= " pressed";
            html+= "<br/>";
        }
 
        for(var i=0;i<gp.axes.length; i+=2) {
            html+= "Stick "+(Math.ceil(i/2)+1)+": "+gp.axes[i]+","+gp.axes[i+1]+"<br/>";
        }
        
        $('#specDisplay').html(gp.axes[0]);
        
 
        $("#gamepadDisplay").html(html);
    }*/
    
    function checkGamepad(input) {
        var gp = navigator.getGamepads()[0];
        var axeLF = gp.axes[0];
        var axeUD = gp.axes[1];
        console.log(gp.axes[1]);
        if(axeLF < -0.5) {
            input.left = true;
            input.right = false;
        } else if(axeLF > 0.5) {
            input.left = false;
            input.right = true;
        } else {
            input.left = false;
            input.right = false;
        }
        
        if (axeUD<-0.5) {
            input.up=true;
            input.down=false;
        }
        else if(axeUD>0.5){
            input.up=false;
            input.down=true;
        }
        else{
            input.up=false;
            input.down=false;
        }
        $('#specDisplay').html(JSON.stringify(input));
        var html='';
        for(var i=0;i<gp.buttons.length;i++) {
            html+= "Button "+(i+1)+": ";
            if(gp.buttons[i].pressed) html+= " pressed";
            html+= "<br/>";
        }
        if(gp.buttons[0].pressed){
            input.a=true;
        }
        else{
            input.a=false;
        }
        if (gp.buttons[1].pressed) {
            input.b=true;
        }
        else{
            input.b=false;
        }
        if (gp.buttons[7].pressed) {
            input.start=true;
        }
        else{
            input.start=false;
        }
        
        $("#gamepadDisplay").html(html);
    }
 
    $(document).ready(function() {
        var isExecuteUp=false;
        var isExecuteDown=false;
        var isExecuteLeft=false;
        var isExecuteRight=false;
        var isExecuteA=false;
        var isExecuteB=false;
        var isExecuteStart=false;
        if(canGame()) {
 
            var prompt = "To begin using your gamepad, connect it and press any button!";
            $("#gamepadPrompt").text(prompt);
 
            $(window).on("gamepadconnected", function() {
                hasGP = true;
                $("#gamepadPrompt").html("Gamepad connected!");
                console.log("connection event");
                //repGP = window.setInterval(checkGamepad(input),100);
                repGP = setInterval(function(){
                    checkGamepad(input);
                    
                    if (input.left) {
                        e = $.Event('keydown');
                        e.keyCode= 37;
                        $(document).trigger(e);
                        //nes.Keyboard.keyDown(37);
                        isExecuteLeft=true;
                    }
                    else{
                        if (isExecuteLeft) {
                            isExecuteLeft=false;
                            e = $.Event('keyup');
                            e.keyCode= 37;
                            $(document).trigger(e);
                        }
                    }
                    if (input.up) {
                        e = $.Event('keydown');
                        e.keyCode= 38;
                        $(document).trigger(e);
                        isExecuteUp=true;
                    }
                    else{
                        if (isExecuteUp) {
                            isExecuteUp=false;
                            e = $.Event('keyup');
                            e.keyCode= 38;
                            $(document).trigger(e);
                        }
                    }
                    if (input.right) {
                        e = $.Event('keydown');
                        e.keyCode= 39;
                        $(document).trigger(e);
                        isExecuteRight=true;
                    }
                    else{
                        if (isExecuteRight) {
                            isExecuteRight=false;
                            e = $.Event('keyup');
                            e.keyCode= 39;
                            $(document).trigger(e);
                        }
                    }
                    
                    if (input.down) {
                        e = $.Event('keydown');
                        e.keyCode= 40;
                        $(document).trigger(e);
                        isExecuteDown=true;
                    }
                    else{
                        if (isExecuteDown) {
                            isExecuteDown=false;
                            e = $.Event('keyup');
                            e.keyCode= 40;
                            $(document).trigger(e);
                        }
                    }
                    
                    if (input.a) {
                        e = $.Event('keydown');
                        e.keyCode= 88;
                        $(document).trigger(e);
                        isExecuteA=true;
                    }
                    else{
                        if (isExecuteA) {
                            isExecuteA=false;
                            e = $.Event('keyup');
                            e.keyCode= 88;
                            $(document).trigger(e);
                        }
                    }
                    
                    if (input.b) {
                        e = $.Event('keydown');
                        e.keyCode= 89;
                        $(document).trigger(e);
                        isExecuteB=true;
                    }
                    else{
                        if (isExecuteB) {
                            isExecuteB=false;
                            e = $.Event('keyup');
                            e.keyCode= 89;
                            $(document).trigger(e);
                        }
                    }
                    
                    if (input.start) {
                        e = $.Event('keydown');
                        e.keyCode= 13;
                        $(document).trigger(e);
                        isExecuteStart=true;
                    }
                    else{
                        if (isExecuteStart) {
                            isExecuteStart=false;
                            e = $.Event('keyup');
                            e.keyCode= 13;
                            $(document).trigger(e);
                        }
                    }
                },100);
            });
 
            $(window).on("gamepaddisconnected", function() {
                console.log("disconnection event");
                $("#gamepadPrompt").text(prompt);
                window.clearInterval(repGP);
            });
 
            //setup an interval for Chrome
            var checkGP = window.setInterval(function() {
                console.log('checkGP');
                if(navigator.getGamepads()[0]) {
                    if(!hasGP) $(window).trigger("gamepadconnected");
                    window.clearInterval(checkGP);
                }
            }, 500);
        }
 
    });
    </script>
    

    <!--<script src="lib/jquery-1.4.2.min.js" type="text/javascript" charset="utf-8"></script>-->
    <script src="NES_JS/lib/dynamicaudio-min.js" type="text/javascript" charset="utf-8"></script>
    <script src="NES_JS/source/nes.js" type="text/javascript" charset="utf-8"></script>
    <script src="NES_JS/source/utils.js" type="text/javascript" charset="utf-8"></script>
    <script src="NES_JS/source/cpu.js" type="text/javascript" charset="utf-8"></script>
    <script src="NES_JS/source/keyboard.js" type="text/javascript" charset="utf-8"></script>
    <script src="NES_JS/source/mappers.js" type="text/javascript" charset="utf-8"></script>
    <script src="NES_JS/source/papu.js" type="text/javascript" charset="utf-8"></script>
    <script src="NES_JS/source/ppu.js" type="text/javascript" charset="utf-8"></script>
    <script src="NES_JS/source/rom.js" type="text/javascript" charset="utf-8"></script>
    <script src="NES_JS/source/ui.js" type="text/javascript" charset="utf-8"></script>
    <script type="text/javascript" charset="utf-8">
        var nes;
        $(function() {
            nes = new JSNES({
                'ui': $('#emulator').JSNESUI({
                    "Working": [
                        ['Super Mario Bros. 1', 'NES_JS/roms/smb1.nes'],
                        ['Super Mario Bros. 3', 'NES_JS/roms/smb3.nes'],
                        ['Megaman 1', 'NES_JS/roms/megaman1.nes'],
                        ['Megaman 2', 'NES_JS/roms/megaman2.nes'],
                        ['Megaman 6', 'NES_JS/roms/Mega Man 6 (USA).nes'],
                        ['owlia','NES_JS/roms/owlia_demo.nes']
                    ]
                })
            });
        });
    </script>
    <!--[if IE]>
        <script type="text/vbscript" src="NES_JS/source/jsnes-ie-hacks.vbscript"></script>
    <![endif]-->
</body>
</html>
